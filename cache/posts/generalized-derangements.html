<p>Derangement problems are quite easy to do when there are no restrictions.
Suppose we want to extend the problem with restrictions, e.g.:</p>
<p><em>There are bins numbered 1,2,3,4,1,2,3,4,1,2 , and there are balls numbered 1,2,3,4,5,1,2,3,4,5 (distinguishable, say, two sets with different colors), and each bin is to contain a single ball such that the number of the bin and the ball should not match. In how many ways can that be done? (or what is the probability of that happening?)</em></p>
<p>This can be solved by using Rook polynomials.</p>
<p>The rook polynomial for a <span class="math">\(m\times n\)</span> rectangle is:</p>
<div class="math">
\begin{equation*}
\displaystyle r_{m,n}(x)=\sum_{k=0}^n{m\choose k}\, {n!\over (n-k)!}\, x^k
\end{equation*}
</div>
<p>For this problem:</p>
<p><span class="math">\(m=\)</span> number of bins numbered 's'</p>
<p><span class="math">\(n=\)</span> number of balls numbered 's'</p>
<p>and the rook polynomial we require to solve our problem is:</p>
<div class="math">
\begin{align*}
\displaystyle R(x)&amp;=r_{3,2}(x)\, r_{3,2}(x)\, r_{2,2}(x)\, r_{2,2}(x)\\\\
R(x)&amp;=(6\, x^2 + 6\, x + 1)^2\, (2\, x^2 + 4\, x + 1)^2
\end{align*}
</div>
<p>Now, with this rook polynomial, the number of ways of derangements can be found in two ways:</p>
<div class="math">
\begin{equation*}
\displaystyle \int_0^\infty \, x^n\, R\left(-\dfrac{1}{x}\right)\, e^{-x}\, dx
\end{equation*}
</div>
<p>where <span class="math">\(n\)</span> is the number of bins.</p>
<p>Another way is to expand <span class="math">\(R(x)\)</span> and replace each <span class="math">\(x^i\)</span> with <span class="math">\(i\cdot (n-i)!\)</span></p>
<p>The answer divided by <span class="math">\(n!\)</span> gives the probability.</p>
<p>Both ways are described in the following Sage code:</p>
<table class="codetable"><tr><td class="linenos"><div class="linenodiv"><pre><a href="#rest_code_33481564981845a9a69a17c6ef0338c5-0"> 0</a>
<a href="#rest_code_33481564981845a9a69a17c6ef0338c5-1"> 1</a>
<a href="#rest_code_33481564981845a9a69a17c6ef0338c5-2"> 2</a>
<a href="#rest_code_33481564981845a9a69a17c6ef0338c5-3"> 3</a>
<a href="#rest_code_33481564981845a9a69a17c6ef0338c5-4"> 4</a>
<a href="#rest_code_33481564981845a9a69a17c6ef0338c5-5"> 5</a>
<a href="#rest_code_33481564981845a9a69a17c6ef0338c5-6"> 6</a>
<a href="#rest_code_33481564981845a9a69a17c6ef0338c5-7"> 7</a>
<a href="#rest_code_33481564981845a9a69a17c6ef0338c5-8"> 8</a>
<a href="#rest_code_33481564981845a9a69a17c6ef0338c5-9"> 9</a>
<a href="#rest_code_33481564981845a9a69a17c6ef0338c5-10">10</a>
<a href="#rest_code_33481564981845a9a69a17c6ef0338c5-11">11</a></pre></div></td><td class="code"><pre class="code python"><a name="rest_code_33481564981845a9a69a17c6ef0338c5-0"></a><span class="n">var</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<a name="rest_code_33481564981845a9a69a17c6ef0338c5-1"></a><span class="k">def</span> <span class="nf">rp</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">):</span> <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">binomial</span><span class="p">(</span><span class="n">SR</span><span class="p">(</span><span class="n">m</span><span class="p">),</span><span class="n">SR</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">^</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<a name="rest_code_33481564981845a9a69a17c6ef0338c5-2"></a><span class="n">summ</span> <span class="o">=</span> <span class="mi">0</span>
<a name="rest_code_33481564981845a9a69a17c6ef0338c5-3"></a><span class="n">balls</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
<a name="rest_code_33481564981845a9a69a17c6ef0338c5-4"></a><span class="n">bins</span> <span class="o">=</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="mi">30</span><span class="p">)[:</span><span class="nb">len</span><span class="p">(</span><span class="n">balls</span><span class="p">)]</span>
<a name="rest_code_33481564981845a9a69a17c6ef0338c5-5"></a><span class="n">stbin</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
<a name="rest_code_33481564981845a9a69a17c6ef0338c5-6"></a><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="n">bins</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stbin</span><span class="p">]</span>
<a name="rest_code_33481564981845a9a69a17c6ef0338c5-7"></a><span class="n">rook</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">expand</span><span class="p">(</span><span class="n">prod</span><span class="p">([</span><span class="n">rp</span><span class="p">(</span><span class="n">bins</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="n">balls</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stbin</span><span class="p">]))</span>
<a name="rest_code_33481564981845a9a69a17c6ef0338c5-8"></a><span class="n">nn</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
<a name="rest_code_33481564981845a9a69a17c6ef0338c5-9"></a><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nn</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
<a name="rest_code_33481564981845a9a69a17c6ef0338c5-10"></a>    <span class="n">summ</span> <span class="o">+=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">^</span><span class="n">i</span><span class="o">*</span><span class="n">rook</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">coefficient</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">factorial</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>
<a name="rest_code_33481564981845a9a69a17c6ef0338c5-11"></a><span class="k">print</span> <span class="n">summ</span><span class="o">/</span><span class="n">factorial</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="s2">&quot;=&quot;</span><span class="p">,</span><span class="n">integrate</span><span class="p">(</span><span class="n">x</span><span class="o">^</span><span class="n">nn</span><span class="o">*</span><span class="n">rook</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">e</span><span class="o">^</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">),</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">oo</span><span class="p">)</span><span class="o">/</span><span class="n">factorial</span><span class="p">(</span><span class="n">nn</span><span class="p">),</span><span class="s2">&quot;~&quot;</span><span class="p">,</span><span class="n">N</span><span class="p">(</span><span class="n">summ</span><span class="o">/</span><span class="n">factorial</span><span class="p">(</span><span class="n">nn</span><span class="p">)),</span><span class="n">summ</span>
</pre></td></tr></table><p><tt class="docutils literal">283/2520 = 283/2520 ~ 0.112301587301587 407520</tt></p>
<p>which agrees with a simulation:</p>
<table class="codetable"><tr><td class="linenos"><div class="linenodiv"><pre><a href="#rest_code_e7e383db457a49919c2f291ac0cff743-0">0</a>
<a href="#rest_code_e7e383db457a49919c2f291ac0cff743-1">1</a>
<a href="#rest_code_e7e383db457a49919c2f291ac0cff743-2">2</a>
<a href="#rest_code_e7e383db457a49919c2f291ac0cff743-3">3</a></pre></div></td><td class="code"><pre class="code text"><a name="rest_code_e7e383db457a49919c2f291ac0cff743-0"></a>lst=.10$1 2 3 4
<a name="rest_code_e7e383db457a49919c2f291ac0cff743-1"></a>a=.2#1+i.5
<a name="rest_code_e7e383db457a49919c2f291ac0cff743-2"></a>sim=: 3 : &#39;0=+/((10?10){a)=lst&#39;
<a name="rest_code_e7e383db457a49919c2f291ac0cff743-3"></a>(+/%#)(sim&quot;0)1000000#0
</pre></td></tr></table><p>which is about <span class="math">\(0.112101\)</span></p>
<p>If we now turn our attention to the classic derangement problem, e.g. 10 bins and balls, each numbered 1 to 10, we change the variables accordingly:</p>
<table class="codetable"><tr><td class="linenos"><div class="linenodiv"><pre><a href="#rest_code_75160eca3d0946c38bb097e27ce1d245-0">0</a>
<a href="#rest_code_75160eca3d0946c38bb097e27ce1d245-1">1</a></pre></div></td><td class="code"><pre class="code python"><a name="rest_code_75160eca3d0946c38bb097e27ce1d245-0"></a><span class="n">balls</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
<a name="rest_code_75160eca3d0946c38bb097e27ce1d245-1"></a><span class="n">bins</span> <span class="o">=</span> <span class="n">balls</span>
</pre></td></tr></table><p>We see that the summ is indeed <span class="math">\(1334961\)</span>, which is the number of derangements, <span class="math">\(D(10)\)</span>.</p>
<p>References:</p>
<p><a class="reference external" href="https://math.stackexchange.com/questions/414023/probability-of-winning-the-game-1-2-3">1. Stackexchange problem</a></p>
<p><a class="reference external" href="http://www.cs.uleth.ca/~holzmann/notes/rook.pdf">2. Notes on rook polynomial</a></p>
